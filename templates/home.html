<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Rate My Guinness</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #000;
      display: flex;
      flex-direction: column;
    }
    .navbar {
      margin-bottom: 0;
    }
    #map-container {
      flex-grow: 1;
      margin: 16px;
      border: 4px solid #444;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 12px #222;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .modal-content {
      border-radius: 1rem;
    }
    .modal-header {
      border-bottom: none;
    }
    .modal-footer {
      border-top: none;
    }
  </style>
</head>
<body>
  <nav class="navbar" style="background: #000; box-shadow: 0 2px 6px rgba(0,0,0,0.5); border: none;">
    <div class="container-fluid justify-content-center">
      <span class="navbar-brand mb-0 h1" style="
        font-family: 'Montserrat', 'Inter', Arial, sans-serif;
        font-weight: 700;
        font-size: 2.2rem;
        letter-spacing: 1.5px;
        color: #FFD700;
        text-shadow: 1px 1px 8px #222, 0 0 2px #FFD700;
        padding-left: 0.2em;">
        Rate My Guinness
      </span>
    </div>
  </nav>

  <div id="map-container">
    <div id="map"></div>
  </div>

  <!-- Rating Modal -->
  <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="place-name">Place Name</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="average-rating" class="mb-2">No ratings yet</div>
          <input type="number" id="rating" min="1" max="5" class="form-control mb-3" placeholder="Rate Guinness 1â€“5">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="submitRating()">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let map;
    let selectedPlace = null;
    let placesService;
    let markers = [];
    let avgRatings = {};
    let infoWindow;
    let ratingModal;

    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            mapInit(userLocation);
          },
          error => {
            console.error("Geolocation error:", error);
            fallbackToDublin();
          }
        );
      } else {
        fallbackToDublin();
      }
    }

    function fallbackToDublin() {
      const dublin = { lat: 53.3498, lng: -6.2603 };
      mapInit(dublin);
    }

    function mapInit(center) {
      map = new google.maps.Map(document.getElementById("map"), {
        center,
        zoom: 14
      });
      placesService = new google.maps.places.PlacesService(map);
      infoWindow = new google.maps.InfoWindow();
      fetchAverageRatings().then(() => {
        searchNearby(center);
      });
      map.addListener("idle", () => {
        const c = map.getCenter();
        if (c) {
          fetchAverageRatings().then(() => {
            searchNearby({ lat: c.lat(), lng: c.lng() });
          });
        }
      });
    }

    async function fetchAverageRatings() {
      try {
        const res = await fetch("/api/ratings");
        const data = await res.json();
        avgRatings = {};
        data.forEach(entry => {
          avgRatings[entry.place_id] = entry;
        });
      } catch (err) {
        console.error("Failed to fetch ratings", err);
      }
    }

    function searchNearby(location) {
      const request = {
        location,
        radius: 1500,
        query: "bar OR pub OR restaurant"
      };
      markers.forEach(marker => marker.setMap(null));
      markers = [];
      const guinnessIcon = {
        url: '/static/images/guinness.png',
        scaledSize: new google.maps.Size(48, 48),
        anchor: new google.maps.Point(24, 48),
        labelOrigin: new google.maps.Point(24, 24)
      };
      // ...test image code removed...
      placesService.textSearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results) {
          results.forEach(place => {
            if (!place.geometry || !place.geometry.location) return;
            const info = avgRatings[place.place_id];
            const ratingLabel = info
              ? `Avg: ${info.average_rating} (${info.rating_count})`
              : "No ratings";
            const marker = new google.maps.Marker({
              map,
              position: place.geometry.location,
              title: place.name,
              icon: guinnessIcon
            });
            marker.addListener("click", () => {
              selectedPlace = {
                name: place.name,
                place_id: place.place_id,
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
              };
              document.getElementById("place-name").innerText = selectedPlace.name;
              document.getElementById("average-rating").innerText = info
                ? `Average rating: ${info.average_rating} (${info.rating_count})`
                : "No ratings yet";
              document.getElementById("rating").value = '';
              ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
              ratingModal.show();
              infoWindow.setContent(`<strong>${place.name}</strong><br>${ratingLabel}`);
              infoWindow.open(map, marker);
            });
            markers.push(marker);
          });
        } else {
          console.error("Places search failed:", status);
        }
      });
    }

    function submitRating() {
      const ratingValue = parseInt(document.getElementById("rating").value);
      if (!ratingValue || ratingValue < 1 || ratingValue > 5) {
        alert("Please enter a valid rating between 1 and 5.");
        return;
      }
      const payload = {
        place: selectedPlace,
        rating: ratingValue
      };
      fetch("/api/ratings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(() => {
        alert("Thanks for your rating!");
        ratingModal.hide();
        fetchAverageRatings().then(() => {
          const center = map.getCenter();
          if (center) {
            searchNearby({ lat: center.lat(), lng: center.lng() });
          }
        });
      })
      .catch(err => {
        console.error(err);
        alert("Something went wrong.");
      });
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMSMcRvyIvSnYzkuArJlie5cxl-R29xgA&callback=initMap&libraries=places">
  </script>
</body>
</html>